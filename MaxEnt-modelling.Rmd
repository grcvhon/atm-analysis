---
title: "MaxEnt modelling for Short-nosed and Leaf-scaled sea snakes"
author: "Vhon Garcia and Vinay Udyawer"
date: "`r Sys.Date()`"
output: html_document
---

```{=html}
<style>
.leaflet {
    margin: auto;
}
</style>
```

------------------------------------------------------------------------

This markdown document outlines analyses and associated code for the project: Tracking Species Trajectories of Short-nosed sea snake (*Aipysurus apraefrontalis*) and Leaf-scaled sea snake (*A*. *foliosquama*); funded by the Department of Climate Change, Energy, the Environment, and Water (ATM_2023_0715).

 

### i. Packages

Install the listed packages (if not already) before running the following code.

```{r load packages, message=FALSE, warning=FALSE}
# List of packages
packages <- c("sf","leaflet","readr","janitor","dplyr",
              "mapview","spatstat","tidyverse","raster",
              "dismo","lubridate","SDMtune","readxl",
              "terra","stars","lwgeom","maptools","ggspatial",
              "prettymapr","tidyverse")
            
# Run library() on package list i.e., library(packages) - all at once
invisible(lapply(packages, library, character.only = TRUE))
```

 

### 1. Input model extent

```{r input model extent, message=FALSE, warning=FALSE}
# Load Northwest shelf bounding area
nw_shelf <- 
  st_read("../data/shapefiles/nw-shelf/NWShelf.shp", quiet = TRUE) %>% 
  st_transform(4326)

# View Northwest shelf bounding area
mapview(nw_shelf)
```

 

### 2. Input environmetal rasters

```{r input environmental rasters, message=FALSE, warning=FALSE, results=FALSE}
# Load single environmental raster
bathymetry <- raster("../data/predictor-variables/bathymetry.asc")

# Load initial set of environmental rasters
env_init <- stack("../data/predictor-variables/sal_mean.asc",
                  "../data/predictor-variables/sal_amp.asc",
                  "../data/predictor-variables/bathymetry.asc",
                  "../data/predictor-variables/sst_mean.asc",
                  "../data/predictor-variables/sst_amp.asc",
                  "../data/predictor-variables/chlor_mean.asc",
                  "../data/predictor-variables/DistToLand.asc",
                  "../data/predictor-variables/DistToReef.asc",
                  "../data/predictor-variables/DistToFW.asc")
```

 

### 3. Input occurrence data

The occurrence data set contains records from DPIRD surveys, records from Atlas of Living Australia (downloaded 21 January 2025), and from the `trawled_seasnakes.xlsx` spreadsheet. Data types are either point coordinates or start and end coordinates of trawls/transects.

 

####       3.1 Load point occurrence data

The point occurrence data were taken as point coordinates of records. For trawled samples, their point coordinates were taken as the mid-latitude and mid-longitude and were calculated by taking the mean of the start and end latitudes/longitudes of the trawl where the specimen was collected.

```{r input occurrence data, message=FALSE, warning=FALSE}
# Combined occurrence data for Aipysurus apraefrontalis and A. foliosquama
rawdat <- read_csv("../data/spreadsheets/ATM_2023_0715-running-master.csv")

# [function] filter by species
filter_species <- function(species_name) {
  rawdat %>%
    mutate(
      lat = as.numeric(MidLat),
      lat = if_else(is.na(lat), as.numeric(Latitude), lat),
      long = as.numeric(MidLong),
      long = if_else(is.na(long), as.numeric(Longitude), long)
    ) %>%
    filter(Species == species_name,
           !is.na(lat),
           !is.na(long)) %>%
    clean_names()
}

# Create data frame filtered for each species
aprae <- filter_species("apraefrontalis")
folio <- filter_species("foliosquama")

# [function] convert filtered data frame to simple feature (sf) 
convert_2_sf <- function(df_name) {
  df_name %>% 
    st_as_sf(coords = c("long", "lat"), crs = 4326) %>% 
    distinct(.keep_all = T)
}

# Convert data frame to simple feature (sf)
aprae_sf <- convert_2_sf(aprae)
folio_sf <- convert_2_sf(folio)

# Combine aprae and folio sf occurrence points
seasnake_sf <- bind_rows(aprae_sf,folio_sf)

# Visualise
mapview(seasnake_sf)
```

 

At this stage, the above plot only shows records for Short-nosed and Leaf-scaled sea snakes. As we go further into the analyses, particularly in defining the bias layer, ideally we would include as much data as we can and use all the occurrences (regardless of species). This is where we can use a larger dataset: `2020-05-20_SnakeOcc.csv` (master data set from Vinay used for all the species distributions).

 

####       3.2 Load transect data

The transect data were taken from `ATM_2023_0715-running-master.csv` and were converted to a shapefile.

```{r, input transect data, message=FALSE, warning=FALSE}
# Specific transect data
aprae_transect <- st_read("../data/shapefiles/apraefrontalis_transect.shp", quiet = TRUE)
folio_transect <- st_read("../data/shapefiles/foliosquama_transect.shp", quiet = TRUE)

# Combined aprae and folio transect lines
seasnake_trn <- st_read("../data/shapefiles/seasnake_transect.shp", quiet = TRUE) 

# Visualise
mapview(seasnake_trn)
```

 

### 4. Generate bias layer

 

####       4.1 Generate bias layer for point occurrences

For the point occurrences, we are going to use `2020-05-20_SnakeOcc.csv` (master data set from Vinay used for all the species distributions).

```{r, bias layer, message=FALSE, warning=FALSE}
# Input master data set used for all species distribution
effort_csv <- read_csv("../data/spreadsheets/2020-05-20_SnakeOcc.csv")
colnames(effort_csv) <- c("species", "long", "lat", "source") # rename columns to suit function

# Convert to simple feature (sf)
effort_sf <- convert_2_sf(effort_csv)

# Vectorise sf object
effort_vect <- vect(effort_sf)

# Mask using model extent i.e., Northwest shelf
effort_nwshelf_sf <- mask(effort_vect, mask = vect(nw_shelf))
effort_nwshelf_sf <- st_as_sf(effort_nwshelf_sf)

# Visualise bias layer from point occurrence data
mapview(effort_nwshelf_sf)
```

 

Proceed with generating point pattern object (ppp):

```{r, ppp, message=FALSE, warning=FALSE, fig.align='center'}
# Generate ppp object
ss_effort_occ_ppp <- 
  effort_nwshelf_sf %>% 
  st_transform(crs = 3577) %>% 
  st_as_sf() %>% 
  as.ppp()

# Calculate Probability (Gaussian) density of points
ss_effort_pts_bias <- 
  ss_effort_occ_ppp %>% 
  density(., sigma = 0.05) %>% 
  terra::rast()

crs(ss_effort_pts_bias) <- "EPSG:3577"

ss_effort_pts_bias <-
  ss_effort_pts_bias %>% 
  terra::project(., y = "EPSG:4326") %>% 
  terra::mask(mask = vect(nw_shelf)) %>% 
  terra::resample(x = ., y = rast(bathymetry)) %>% 
  terra::scale()

ss_effort_pts_bias[values(ss_effort_pts_bias) < 0] <- NA

# Normalise the bias layer (rescale between 0 and 1)
nx_effort <- minmax(ss_effort_pts_bias)    
ss_effort_pts_bias <- (ss_effort_pts_bias - nx_effort[1,]) / (nx_effort[2,] - nx_effort[1,])

# Visualise points bias layer
mapview(ss_effort_pts_bias) +
  mapview(nw_shelf, alpha.region = 0)
```

 

 

####       4.2 Generate bias layer for transect data

To generate the transect bias layer, we are going to use the data in `seasnake_trn` shapefile.

```{r, psp, message=FALSE, warning=FALSE}
# Generate pairwise point pattern object (psp)
seasnake_trn_psp <- 
  seasnake_trn %>% 
  st_transform(crs = 3577) %>% 
  st_as_sfc() %>% 
  as.psp()

# Calculate Probability (Gaussian) density of transects
seasnake_trn_bias <- 
  seasnake_trn_psp %>% 
  density(., sigma = 0.05) %>% 
  terra::rast()

crs(seasnake_trn_bias) <- "EPSG:3577"

seasnake_trn_bias <- 
  seasnake_trn_bias %>% 
  terra::project(., y = "EPSG:4326") %>% 
  terra::mask(mask = vect(nw_shelf)) %>% 
  terra::resample(x = ., y = rast(bathymetry)) %>% 
  terra::scale()

seasnake_trn_bias[values(seasnake_trn_bias) < 0] <- NA

## Normalise the bias layer (rescale between 0 and 1)
nx <- minmax(seasnake_trn_bias)    
seasnake_trn_bias <- (seasnake_trn_bias - nx[1,]) / (nx[2,] - nx[1,])

# plot(seasnake_trn_bias)
mapview(seasnake_trn_bias)
```

 

Lets combine the points and transect bias layers (average between the two).

```{r, combine, message=FALSE, warning=FALSE}
# Combine the points and transect bias layers by taking the average
seasnake_bias_layer <- mean(ss_effort_pts_bias, seasnake_trn_bias, na.rm = T)

seasnake_bias_layer <-
  terra::mask(seasnake_bias_layer, mask = vect(nw_shelf))

# Visualise combined bias layer
mapview(seasnake_bias_layer, na.color = NA) +
  mapview(nw_shelf, alpha.regions = 0)
```

 

Then we can write the bias layer to a file so it's ready to load for next time.

```{r, printbias, message=FALSE, warning=FALSE, eval=FALSE}
# Save bias layer as a raster file
writeRaster(seasnake_bias_layer, "../data/bias_layer.tiff")
```

 

***...to be continued with generating pseudo-absence data***
